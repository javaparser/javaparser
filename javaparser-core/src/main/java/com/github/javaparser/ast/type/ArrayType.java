package com.github.javaparser.ast.type;

import com.github.javaparser.Position;
import com.github.javaparser.Range;
import com.github.javaparser.ast.ArrayBracketPair;
import com.github.javaparser.ast.NodeList;
import com.github.javaparser.ast.expr.AnnotationExpr;
import com.github.javaparser.ast.nodeTypes.NodeWithAnnotations;
import com.github.javaparser.ast.visitor.GenericVisitor;
import com.github.javaparser.ast.visitor.VoidVisitor;
import com.github.javaparser.utils.Pair;

import static com.github.javaparser.ast.NodeList.nodeList;
import static com.github.javaparser.utils.Utils.assertNotNull;

/**
 * To indicate that a type is an array, it gets wrapped in an ArrayType for every array level it has.
 * So, int[][] becomes ArrayType(ArrayType(int)).
 */
public class ArrayType extends ReferenceType<ArrayType> implements NodeWithAnnotations<ArrayType> {
    private Type componentType;

    public ArrayType(Type<?> componentType, NodeList<AnnotationExpr> annotations) {
        this(Range.UNKNOWN, componentType, annotations);
    }

    public ArrayType(Range range, Type<?> componentType, NodeList<AnnotationExpr> annotations) {
        super(range);
        setComponentType(componentType);
        setAnnotations(annotations);
    }

    @Override public <R, A> R accept(final GenericVisitor<R, A> v, final A arg) {
        return v.visit(this, arg);
    }

    @Override public <A> void accept(final VoidVisitor<A> v, final A arg) {
        v.visit(this, arg);
    }

    public Type getComponentType() {
        return componentType;
    }

    public ArrayType setComponentType(final Type<?> type) {
        this.componentType = assertNotNull(type);
        setAsParentNodeOf(this.componentType);
        return this;
    }

    /**
     * Takes lists of arrayBracketPairs, assumes the lists are ordered left to right and the pairs are ordered left to right, mirroring the actual code.
     * The type gets wrapped in ArrayTypes so that the outermost ArrayType corresponds to the rightmost ArrayBracketPair.
     */
    @SafeVarargs
    public static Type wrapInArrayTypes(Type type, NodeList<ArrayBracketPair>... arrayBracketPairLists) {
        for (int i = arrayBracketPairLists.length - 1; i >= 0; i--) {
            final NodeList<ArrayBracketPair> arrayBracketPairList = arrayBracketPairLists[i];
            if (arrayBracketPairList != null) {
                for (int j = arrayBracketPairList.size() - 1; j >= 0; j--) {
                    // if the type has a position we can use it to derive the position of the ArrayType and possibly
                    // also the one of the ArrayBracketPair
                    if (!type.getRange().equals(Range.UNKNOWN)) {
                        ArrayBracketPair arrayBracketPair = arrayBracketPairList.get(j);
                        if (arrayBracketPair.getRange().equals(Range.UNKNOWN)) {
                            Position bracketsStart = type.getRange().end.withColumn(type.getRange().end.column + 1);
                            Position bracketsEnd = type.getRange().end.withColumn(type.getRange().end.column + 2);
                            arrayBracketPairList.get(j).setRange(new Range(bracketsStart, bracketsEnd));
                        }
                        Range range = type.getRange().withEnd(arrayBracketPair.getEnd());
                        type = new ArrayType(range, type, arrayBracketPairList.get(j).getAnnotations());
                    } else {
                        type = new ArrayType(type, arrayBracketPairList.get(j).getAnnotations());
                    }
                }
            }
        }
        return type;
    }

    /**
     * Takes a type that may be an ArrayType. Unwraps ArrayTypes until the element type is found.
     *
     * @return a pair of the element type, and the unwrapped ArrayTypes, if any.
     */
    public static Pair<Type, NodeList<ArrayBracketPair>> unwrapArrayTypes(Type type) {
        final NodeList<ArrayBracketPair> arrayBracketPairs = new NodeList<>();
        while (type instanceof ArrayType) {
            ArrayType arrayType = (ArrayType) type;
            arrayBracketPairs.add(new ArrayBracketPair(Range.UNKNOWN, arrayType.getAnnotations()));
            type = arrayType.getComponentType();
        }
        return new Pair<>(type, arrayBracketPairs);
    }
    
    public static ArrayType arrayOf(Type type, AnnotationExpr... annotations) {
        return new ArrayType(type, nodeList(annotations));
    }
}
